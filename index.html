<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تقييم أداء الموظفين</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            min-width: 900px; /* لضمان عرض الجدول بشكل كامل على الشاشات الصغيرة */
        }

        .container {
            width: 95%;
            max-width: 1300px;
            min-height: 800px;
            margin: 20px auto;
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
        }

        .header-title { /* تنسيق العنوان الجديد */
            font-size: 2.2em; /* حجم أكبر */
            color: #2c3e50; /* لون داكن */
            text-align: center;
            margin-bottom: 20px; /* مسافة تحت العنوان */
            font-weight: 700; /* خط سميك */
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db; /* خط سفلي سميك */
        }

        h1, h2 {
            color: #3498db;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .selection-section {
            margin-bottom: 40px;
            padding: 30px;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .selection-section label {
            display: block;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
        }

        .selection-section select {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1.1em;
            background-color: #fff;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="#777" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 20px;
            cursor: pointer;
        }

        .tabs-container {
            display: none; /* مخفي افتراضياً */
        }
        
        /* إخفاء حاوية الأزرار بشكل افتراضي */
        .tabs {
            display: none; /* سيتم التحكم بها بواسطة JS */
            border-bottom: 2px solid #ddd;
            margin-bottom: 30px;
            flex-wrap: wrap; 
        }

        .tab-button {
            padding: 14px 22px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            background-color: #f0f0f0;
            margin-left: 5px;
            margin-bottom: -2px; /* لضمان تلاصق الأزرار مع الحدود السفلية */
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            flex-shrink: 0; 
            white-space: nowrap;
        }

        .tab-button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            display: none;
            padding: 20px; 
            border: 1px solid #ddd;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            background-color: #f9f9f9;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            color: #444;
            margin-bottom: 20px;
        }

        /* Styling for the new form elements specific to tables */
        .evaluation-table {
            width: 100%; 
            border-collapse: collapse;
            margin-bottom: 25px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box; 
        }

        .evaluation-table th,
        .evaluation-table td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: center;
        }

        .evaluation-table th {
            background-color: #eef5f5;
            color: #444;
            font-weight: 600;
        }
        
        /* السماح للنص بالتدفق في رؤوس الأعمدة الرئيسية لبعض التبويبات */
        #tab3 .evaluation-table th,
        #underTrialTab .evaluation-table th {
            white-space: normal; 
        }

        .evaluation-table td {
            background-color: #fff;
            color: #555;
        }

        .evaluation-table input[type="number"],
        .evaluation-table input[type="text"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 1em;
            box-sizing: border-box;
        }
        
        /* خاص بمدخلات النسب المئوية في التبويب الثاني */
        .evaluation-table .percent-input {
            width: 60px;
        }
        .evaluation-table .max-score-input {
            width: 60px;
        }
        /* تعديل خاص لتبويب 2 لجعل النسبة المئوية على اليسار */
        #tab2 .evaluation-table input[type="number"] {
            width: calc(100% - 25px); /* اجعل حقول الإدخال تملأ الخلية تقريباً مع ترك مسافة لـ % */
            display: inline-block;
            text-align: right; /* اجعل الأرقام تبدأ من اليمين */
            padding-right: 5px; /* مسافة للعلامة */
        }
        #tab2 .evaluation-table td {
            position: relative; /* لتحديد موقع العلامة */
        }
        #tab2 .evaluation-table td::after {
            content: '%';
            position: absolute;
            left: 5px; /* علامة % على اليسار */
            top: 50%;
            transform: translateY(-50%);
            color: #555;
            font-weight: normal;
        }


        /* تنسيق خاص بمدخلات التبويب الثالث */
        #tab3 .evaluation-table input[type="number"],
        #tab3 .evaluation-table input[type="text"] {
            width: 90%; 
        }
        /* تعديل خاص لتبويب 3 لجعل النسبة المئوية على اليسار */
        #tab3 .evaluation-table .achieved-ratio-cell {
            position: relative;
        }
        #tab3 .evaluation-table .achieved-ratio-cell input {
            width: calc(100% - 25px); /* مسافة للعلامة */
            text-align: right; /* لجعل الأرقام تبدأ من اليمين */
            padding-right: 5px;
        }
        #tab3 .evaluation-table .achieved-ratio-cell::after {
            content: '%';
            position: absolute;
            left: 8px; /* علامة % على اليسار */
            top: 50%;
            transform: translateY(-50%);
            color: #555;
            font-weight: normal;
        }


        /* تنسيق خاص بمدخلات تبويب الموظف تحت التجربة */
        #underTrialTab .evaluation-table input[type="number"],
        #underTrialTab .evaluation-table input[type="text"] {
            width: 90%; 
        }

        .evaluation-table .competency-name {
            text-align: right;
            font-weight: 500;
        }

        .evaluation-table .score-option label {
            margin: 0 5px;
            font-size: 0.95em;
            cursor: pointer;
            display: flex; /* لجعل الرقم ودائرة الراديو في سطر واحد */
            align-items: center; /* لمحاذاة عمودية */
            justify-content: center; /* لتوسيط المحتوى */
        }

        .evaluation-table .score-option input[type="radio"] {
            margin-right: 3px;
            margin-left: 3px; /* لترك مسافة بسيطة بين الرقم والدائرة */
            transform: scale(1.1); /* تكبير دائرة الراديو قليلاً */
        }
        
        /* تنسيق لحقول النسبة المحققة في التبويب الأول (تم تعديل المحاذاة) */
        #tab1 .evaluation-table .achieved-ratio-cell {
            position: relative; /* لجعل علامة % موضوعة بشكل صحيح */
        }
        #tab1 .evaluation-table .achieved-ratio-cell input[type="text"] { 
            width: calc(100% - 25px); 
            display: inline-block;
            text-align: center; /* **تعديل هنا: لتوسيط القيمة** */
            padding-right: 5px; 
            padding-left: 25px; /* مسافة لعلامة % */
            background-color: #f0f0f0; /* لون خلفية للتمييز */
            cursor: default; /* إشارة إلى أنه للقراءة فقط */
        }
        /* تغيير مكان النسبة المئوية في التبويب الأول */
        #tab1 .evaluation-table .achieved-ratio-cell::after {
            content: '%';
            position: absolute;
            left: 8px; /* مكان علامة % الآن على اليسار */
            top: 50%;
            transform: translateY(-50%);
            color: #555;
            font-weight: normal;
        }


        /* تنسيق جديد لصفوف المجاميع لضمان المحاذاة */
        .total-row {
            background-color: #e6f2f9; /* Light blue for summary rows */
            font-weight: bold;
        }
        .total-row th {
            text-align: right; /* محاذاة النص "المجموع" لليمين */
            padding-right: 20px; /* مسافة داخلية */
        }
        .total-row td {
            text-align: center;
            vertical-align: middle;
            position: relative; /* لجعل span يطفو داخل الخلية */
        }                
        .total-row .total-value-input {
            width: 80px; /* نفس عرض حقول الأرقام الأخرى */
            display: inline-block; /* لكي يكون بجانب النص في الخلية */
            background-color: #fff;
        }
        /* تنسيق خاص للمجموع الأول ليحتل عدة أعمدة */
        #totalDesiredCompetencyCell {
            text-align: center; /* للتأكد من أن حقل الإدخال في المنتصف */
        }        
        #totalDesiredCompetencyCell input {
            width: 100%; /* اجعل الحقل يملأ الخلية المدمجة */
            box-sizing: border-box; /* لضمان أن العرض يشمل البادينغ والحدود */
        }
        /* تنسيق التقييم النهائي */
        .final-evaluation-row {
            background-color: #dbe9f5; /* Slightly darker blue for final evaluation */
            font-weight: bold;
            font-size: 1.1em;
        }        
        .final-evaluation-row th {
            text-align: right;
            padding-right: 20px;
        }

        /* زر الإرسال */        
        button[type="submit"] {
            background-color: #2ecc71;
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            display: block; /* Make it a block element to center */
            margin: 25px auto 0 auto; /* Center the button */
        }
        button[type="submit"]:hover {
            background-color: #27ae60;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
            text-align: center;
        }
        /* تعديلات محددة لتبويب 3 لتحسين العرض */        
        #tab3 .evaluation-table {
            table-layout: fixed; /* يفرض عرض الأعمدة بناءً على العرض المحدد */
            width: 100%; /* تأكد من أنه يملأ العرض المتاح */
        }
        
        #tab3 .evaluation-table th:nth-child(1) { width: 5%; } /* الرقم */        
        #tab3 .evaluation-table th:nth-child(2) { width: 50%; } /* النتائج المطلوب من الموظف تحقيقها */        
        #tab3 .evaluation-table th:nth-child(3) { width: 15%; } /* الأهمية النسبية */        
        #tab3 .evaluation-table th:nth-child(4) { width: 15%; } /* نسبة الإنجاز الفعلية */        
        #tab3 .evaluation-table th:nth-child(5) { width: 15%; } /* العلامة المستحقة */
                
        /* تعديل خاص لعمود الأهمية النسبية والعلامة المستحقة في التبويب الثالث لرؤوس الأعمدة */        
        #tab3 .evaluation-table th[colspan="2"] {
            text-align: center;
        }

        .results-count-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border: 1px solid #cceeff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .results-count-section label {
            font-size: 1.1em;
            font-weight: bold;
            color: #337ab7;
            margin-bottom: 0;
        }

        .results-count-section input[type="number"] {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #aaddff;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
        }

        /* تنسيقات التبويب الرابع الجديد (تقييم الأداء) */
        #tab4 .summary-table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        #tab4 .summary-table th,
        #tab4 .summary-table td {
            border: 1px solid #e0e0e0;
            padding: 15px 20px;
            text-align: right;
            font-size: 1.1em;
        }

        #tab4 .summary-table th {
            background-color: #eef5f5;
            color: #444;
            font-weight: 600;
        }

        #tab4 .summary-table td {
            background-color: #fff;
            color: #555;
            text-align: center;
            width: 30%;
        }

        #tab4 .summary-table input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 1.1em;
            background-color: #f0f0f0;
            box-sizing: border-box;
        }

        .final-grade-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #dbe9f5;
            border: 1px solid #cceeff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            font-size: 1.3em;
            font-weight: bold;
            color: #2a6496;
        }

        .final-grade-section label {
            margin-bottom: 0;
        }

        .final-grade-section input {
            flex-grow: 1;
            max-width: 250px;
            padding: 10px 15px;
            border: 1px solid #99ccff;
            border-radius: 5px;
            font-size: 1.2em;
            text-align: center;
            background-color: #fff;
        }

        /* خاص بتبويب الموظف تحت التجربة */
        #underTrialTab .evaluation-table {
            table-layout: fixed;
            width: 100%;
        }
        #underTrialTab .evaluation-table th:nth-child(1) { width: 5%; } /* الرقم */
        #underTrialTab .evaluation-table th:nth-child(2) { width: 60%; text-align: right; } /* عناصر الأداء والسلوك الوظيفي */
        #underTrialTab .evaluation-table th:nth-child(3) { width: 15%; } /* العلامة القصوى */
        #underTrialTab .evaluation-table th:nth-child(4) { width: 20%; } /* العلامة المتحققة */

        #underTrialTab .evaluation-table td:nth-child(2) { text-align: right; } /* محاذاة نص الكفاءات */

        #underTrialTab .final-grade-section {
            margin-top: 40px;
            border-top: 2px solid #ccc; /* فاصل مرئي */
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="header-title">مديرية صحة محافظة مادبا</h2>
        <h1>نظام تقييم أداء الموظفين</h1>

        <div class="selection-section">
            <label for="evaluationType">الرجاء تحديد نوع التقييم:</label>
            <select id="evaluationType" onchange="showEvaluationForms()">
                <option value="">-- اختر نوع التقييم --</option>
                <option value="specialized">نموذج تقييم الوظائف التخصصية</option>
                <option value="supportServices">وظائف الخدمات المساندة والحرفية</option>
                <option value="underTrial">نموذج الموظف تحت التجربة</option>
            </select>
        </div>

        <div id="evaluationForms" class="tabs-container">
            <h2>نموذج التقييم</h2>
            
            <div id="standardTabsContainer" class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'tab3')">مجموع العلامة المستحقة للنتائج</button>
                <button class="tab-button" onclick="openTab(event, 'tab1')">التقييم النهائي للكفايات</button>
                <button class="tab-button" onclick="openTab(event, 'tab2')">مجموع النسبة المستحقة لعناصر التميز الوظيفي</button>
                <button class="tab-button" onclick="openTab(event, 'tab4')">تقييم الأداء</button>
            </div>

            <div id="tab3" class="tab-content">
                <h3>مجموع العلامة المستحقة للنتائج المطلوب من الموظف تحقيقها</h3>
                <p>الرجاء إدخال البيانات التالية:</p>

                <div class="results-count-section">
                    <label for="numResults">تحديد عدد النتائج المطلوب من الموظف تحقيقها (1-10):</label>
                    <input type="number" id="numResults" value="5" min="1" max="10" onchange="generateTab3Rows()">
                </div>

                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th rowspan="2">الرقم</th>
                            <th rowspan="2" style="width: 50%;">النتائج المطلوب من الموظف تحقيقها</th>
                            <th colspan="1">الأهمية النسبية (العلامة القصوى)</th>
                            <th rowspan="2">نسبة الإنجاز الفعلية (3)</th>
                            <th rowspan="2">العلامة المستحقة (2)</th>
                        </tr>
                        <tr>
                            <th>(وفق أهميتها النسبية)</th>
                        </tr>
                    </thead>
                    <tbody id="tab3-tbody">
                        </tbody>
                </table>
                <div id="tab3-error-message" class="error-message" style="display: none;"></div>
            </div>

            <div id="tab1" class="tab-content">
                <h3>التقييم النهائي للكفايات</h3>
                <p>الرجاء إدخال البيانات الخاصة بالتقييم:</p>

                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th rowspan="2">الكفاءات السلوكية</th>
                            <th colspan="4">مستوى الكفاءة المطلوبة (3)</th>
                            <th rowspan="2">النسبة المحققة من الكفاية (4)</th>
                            <th rowspan="2">المستوى الفعلي للكفاية لدى الموظف (5)</th>
                        </tr>
                        <tr>
                            <th>خبير (4)</th>
                            <th>متقدم (3)</th>
                            <th>متوسط (2)</th>
                            <th>أساسي (1)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-competency="communication" data-achieved-ratio="80">
                            <td class="competency-name">الاتصال والتواصل الفعال</td>
                            <td class="score-option"><label><input type="radio" name="commScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="commScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="commScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="commScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="80" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr data-competency="problemSolving" data-achieved-ratio="90">
                            <td class="competency-name">حل المشكلات</td>
                            <td class="score-option"><label><input type="radio" name="probScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="probScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="probScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="probScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="90" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr data-competency="customerOrientation" data-achieved-ratio="85">
                            <td class="competency-name">التوجه نحو متلقي الخدمة</td>
                            <td class="score-option"><label><input type="radio" name="custScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="custScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="custScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="custScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="85" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr data-competency="accountability" data-achieved-ratio="70">
                            <td class="competency-name">المساءلة</td>
                            <td class="score-option"><label><input type="radio" name="accScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="accScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="accScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="accScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="70" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr data-competency="innovation" data-achieved-ratio="100">
                            <td class="competency-name">الإبداع والابتكار</td>
                            <td class="score-option"><label><input type="radio" name="innovScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="innovScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="innovScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="innovScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="100" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr data-competency="adaptability" data-achieved-ratio="90">
                            <td class="competency-name">التكيف</td>
                            <td class="score-option"><label><input type="radio" name="adaptScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="adaptScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="adaptScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="adaptScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="90" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr data-competency="selfDevelopment" data-achieved-ratio="75">
                            <td class="competency-name">تنمية الذات</td>
                            <td class="score-option"><label><input type="radio" name="selfDevScore" value="4" onchange="calculateAllTab1()">4</label></td>
                            <td class="score-option"><label><input type="radio" name="selfDevScore" value="3" onchange="calculateAllTab1()">3</label></td>
                            <td class="score-option"><label><input type="radio" name="selfDevScore" value="2" onchange="calculateAllTab1()">2</label></td>
                            <td class="score-option"><label><input type="radio" name="selfDevScore" value="1" onchange="calculateAllTab1()">1</label></td>
                            <td class="achieved-ratio-cell"><input type="text" class="achieved-ratio" value="75" readonly></td>
                            <td><input type="text" class="actual-level" readonly></td>
                        </tr>
                        <tr class="total-row">
                            <th class="competency-name">المجموع</th>
                            <td id="totalDesiredCompetencyCell" colspan="4">
                                <input type="text" id="totalDesiredCompetency" class="total-value-input" readonly>
                            </td>
                            <td colspan="1"></td> <td colspan="1"></td> </tr>
                        <tr class="total-row">
                            <th colspan="6">المجموع (المستوى الفعلي 6)</th>
                            <td><input type="text" id="totalActualLevel" class="total-value-input" readonly></td>
                        </tr>
                        <tr class="final-evaluation-row">
                            <th colspan="6">التقييم النهائي (7)</th>
                            <td><input type="text" id="finalEvaluation" class="total-value-input" readonly></td>
                        </tr>
                    </tbody>
                </table>
                 <div id="tab1-error-message" class="error-message" style="display: none;"></div>
            </div>

            <div id="tab2" class="tab-content">
                <h3>مجموع النسبة المستحقة لعناصر التميز الوظيفي (8)</h3>
                <p>الرجاء إدخال البيانات التالية:</p>

                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th style="width: 55%;">البيان</th>
                            <th style="width: 20%;">الأهمية النسبية (العلامة القصوى)</th>
                            <th style="width: 25%;">النسبة المستحقة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-item="initiative">
                            <td class="competency-name">المبادرة في تقديم أفكار إبداعية ومبادرات ومقترحات تؤدي إلى تحسين وتبسيط العمل.</td>
                            <td><input type="number" class="max-score-input" oninput="calculateAllTab2()" min="0"></td>
                            <td><input type="number" class="deserved-percentage" oninput="calculateAllTab2()" min="0"></td>
                        </tr>
                        <tr data-item="knowledgeTransfer">
                            <td class="competency-name">نقل المعرفة للعاملين في الدائرة وفي القطاع العام من خلال تقديم ورشات عمل ودراسات وأبحاث ونشرات إرشادية.</td>
                            <td><input type="number" class="max-score-input" oninput="calculateAllTab2()" min="0"></td>
                            <td><input type="number" class="deserved-percentage" oninput="calculateAllTab2()" min="0"></td>
                        </tr>
                        <tr data-item="volunteering">
                            <td class="competency-name">القيام بأنشطة تطوعية ضمن المسؤولية المجتمعية للدائرة.</td>
                            <td><input type="number" class="max-score-input" oninput="calculateAllTab2()" min="0"></td>
                            <td><input type="number" class="deserved-percentage" oninput="calculateAllTab2()" min="0"></td>
                        </tr>
                        <tr class="total-row">
                            <th colspan="2" style="text-align: right; padding-right: 20px;">مجموع النسبة المستحقة</th>
                            <td style="position: relative;">
                                <input type="text" id="totalDeservedPercentage" class="total-value-input" readonly style="width: calc(100% - 25px); text-align: right; padding-right: 5px;">
                                <span style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%);">%</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div id="tab2-error-message" class="error-message" style="display: none;"></div>
            </div>
            
            <div id="tab4" class="tab-content">
                <h3>تقييم الأداء</h3>
                <p>يلرجى إدراج النتائج التي تم احتسابها في الجزء الثاني من هذا النموذج:</p>

                <table class="summary-table">
                    <tbody>
                        <tr>
                            <th>أ- مجموع العلامة المستحقة للنتائج المطلوب من الموظف تحقيقها</th>
                            <td><input type="text" id="summaryTab3Mark" readonly></td>
                        </tr>
                        <tr>
                            <th>ب- التقييم النهائي للكفايات</th>
                            <td><input type="text" id="summaryTab1Evaluation" readonly></td>
                        </tr>
                        <tr>
                            <th>ج- مجموع النسبة المستحقة لعناصر التميز الوظيفي</th>
                            <td><input type="text" id="summaryTab2Percentage" readonly></td>
                        </tr>
                        <tr class="total-row">
                            <th>المجموع النهائي (العلامة)</th>
                            <td><input type="text" id="finalTotalScore" readonly></td>
                        </tr>
                    </tbody>
                </table>

                <div class="final-grade-section">
                    <label>* التقدير العام</label>
                    <input type="text" id="overallGrade" readonly>
                </div>
            </div>

            <div id="underTrialTab" class="tab-content">
                <h3>تقييم عناصر الأداء والسلوك الوظيفي</h3>
                <p>الرجاء إدخال العلامات المتحققة لكل عنصر:</p>
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>الرقم</th>
                            <th style="width: 60%;">عناصر الأداء والسلوك الوظيفي</th>
                            <th>العلامة القصوى</th>
                            <th>العلامة المتحققة</th>
                        </tr>
                    </thead>
                    <tbody id="underTrial-tbody">
                        <tr data-item="leadership">
                            <td>1</td>
                            <td>لديه القدرة على التنظيم والتخطيط وتحديد أولويات العمل.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="planningGoals">
                            <td>2</td>
                            <td>يلتزم بتحقيق الأهداف والمهام الموكلة له ضمن الأطر الزمنية المحددة.</td>
                            <td>8</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="8"></td>
                        </tr>
                        <tr data-item="achievingGoals">
                            <td>3</td>
                            <td>ينجز المهام والأهداف بالمستوى المطلوب كما ونوعاً.</td>
                            <td>8</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="8"></td>
                        </tr>
                        <tr data-item="knowledgeAwareness">
                            <td>4</td>
                            <td>يطلع على آخر المستجدات والممارسات الفضلى في مجال العمل.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="serviceReceiverOrientation">
                            <td>5</td>
                            <td>يدرك مختلف فئات متلقي الخدمة ويعرف احتياجات ومتطلبات كل فئة من الفئات و يتعامل مع التغذية الراجعة وفقا للسياسات المتبعة.</td>
                            <td>7</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="7"></td>
                        </tr>
                        <tr data-item="responsibility">
                            <td>6</td>
                            <td>لديه القدرة تحمل المسؤولية فيما يتعلق بكافة المهام والمسؤوليات وتحقيق الالتزامات وواجبات الوظيفة التي يشغلها.</td>
                            <td>6</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="6"></td>
                        </tr>
                        <tr data-item="selfDevelopment">
                            <td>7</td>
                            <td>يهتم بأهداف الدائرة و رسالتها و يلتزم بقيمها.</td>
                            <td>6</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="6"></td>
                        </tr>
                        <tr data-item="policyAdherence">
                            <td>8</td>
                            <td>يلتزم بتطبيق التشريعات و السياسات الناظمة للعمل.</td>
                            <td>6</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="6"></td>
                        </tr>
                        <tr data-item="problemSolvingSkills">
                            <td>9</td>
                            <td>لديه القدرة على التعرف على مشاكل العمل و تحديدها بوضوح و جمع المعلومات ذات الصلة بالمشكلة و إقتراح حلول لها.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="continuousLearning">
                            <td>10</td>
                            <td>يظهر إستعداداً للإستفادة من جميع فرص التعلم المتاحة و المبادرات التدريبية المقدمة لتعزيز أداءه و تحسين قدراته لتلبية متطلبات العمل و المهام المطلوبة منه.</td>
                            <td>4</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="4"></td>
                        </tr>
                        <tr data-item="technologyUsage">
                            <td>11</td>
                            <td>يستخدم التقنيات و الوسائل الحديثة في مجال العمل و يتعامل مع التحديات البسيطة عند استخدامها.</td>
                            <td>4</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="4"></td>
                        </tr>
                        <tr data-item="skillDevelopment">
                            <td>12</td>
                            <td>يبدي اهتماماً مستمراً بتطوير الذات و اكتساب المعرفة و تطوير المهارات الضرورية لمجال عمله.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="communicationSkills">
                            <td>13</td>
                            <td>لديه القدرة على التواصل وإيصال الأفكار بوضوح و صفاء الجيد.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="teamwork">
                            <td>14</td>
                            <td>يعمل بفاعلية ضمن فريق العمل و يحترم وجهات نظر الآخرين ويتقبل التنوع والاختلاف.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="initiativeInnovation">
                            <td>15</td>
                            <td>لديه القدرة على طرح أفكار وحلول إبداعية وتوظيفها في تطوير العمل.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="informationSecurity">
                            <td>16</td>
                            <td>يلتزم بسرية المعلومات والقوانين والأنظمة الخاصة بالعمل.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr data-item="assetProtection">
                            <td>17</td>
                            <td>يحافظ على المعدات والأجهزة الخاصة بالعمل.</td>
                            <td>5</td>
                            <td><input type="number" class="achieved-mark-underTrial" oninput="calculateUnderTrialTab()" min="0" max="5"></td>
                        </tr>
                        <tr class="total-row">
                            <th colspan="2" style="text-align: right;">المجموع</th>
                            <td><input type="text" value="100" class="total-value-input" readonly></td>
                            <td><input type="text" id="totalAchievedUnderTrial" class="total-value-input" readonly></td>
                        </tr>
                    </tbody>
                </table>
                <div id="underTrial-error-message" class="error-message" style="display: none;"></div>

                <div class="final-grade-section">
                    <label>* التقدير العام</label>
                    <input type="text" id="overallGradeUnderTrial" readonly>
                </div>
            </div>

        </div>
    </div>

    <script>
        // دالة مساعدة لجعل قيمة الحقل فارغة إذا كانت 0 أو NaN
        function formatOutputValue(value) {
            return (isNaN(value) || value === 0 || value === null) ? '' : value.toFixed(2);
        }

        // دالة لتحديد النسب المئوية النهائية بناءً على نوع التقييم
        function getEvaluationWeights() {
            const evaluationType = document.getElementById('evaluationType').value;
            let weights = {
                tab1Weight: 0.20, // 20% for Specialized / Under Trial (default)
                tab3MaxScoreSum: 65 // 65% for Specialized / Under Trial (default)
            };

            if (evaluationType === 'supportServices') {
                weights.tab1Weight = 0.30; // 30% for Support Services
                weights.tab3MaxScoreSum = 55; // 55% for Support Services
            }
            // 'underTrial' type uses calculateUnderTrialTab() directly and does not rely on these weights for overall calculation

            return weights;
        }

        function showEvaluationForms() {
            const evaluationType = document.getElementById('evaluationType').value;
            const evaluationFormsDiv = document.getElementById('evaluationForms');
            const standardTabsContainer = document.getElementById('standardTabsContainer');
            const underTrialTabContent = document.getElementById('underTrialTab');

            // إخفاء جميع التبويبات والمحتويات أولاً
            evaluationFormsDiv.style.display = 'none';
            standardTabsContainer.style.display = 'none';
            underTrialTabContent.style.display = 'none';
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            if (evaluationType) {
                evaluationFormsDiv.style.display = 'block';
                
                if (evaluationType === 'underTrial') {
                    // إظهار تبويب الموظف تحت التجربة فقط
                    underTrialTabContent.style.display = 'block';
                    calculateUnderTrialTab(); // حساب التبويب فوراً
                } else {
                    // إظهار التبويبات القياسية (وظائف تخصصية وخدمات مساندة)
                    standardTabsContainer.style.display = 'flex'; // لإظهار الأزرار
                    // تفعيل التبويب الأول افتراضياً بعد إعادة الترتيب
                    openTab(null, 'tab3'); // الآن tab3 هو الأول
                    // إعادة حساب جميع التبويبات القياسية لضمان تحديث التبويب الرابع
                    generateTab3Rows(); // يجب أن يتم استدعاؤها أولاً لضمان وجود الصفوف قبل حساباتها
                    calculateAllTab3(); 
                    calculateAllTab1(); 
                    calculateAllTab2();
                    updateTab4Summary(); // تحديث التبويب الرابع بعد حسابات كل التبويبات الأخرى
                }
            }
        }

        function openTab(evt, tabName) {
            let i, tabcontent, tabbuttons;

            // إخفاء كل محتويات التبويبات أولاً
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove('active');
            }

            // إزالة حالة النشاط من كل أزرار التبويبات
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            
            // تفعيل التبويب والمحتوى المطلوب
            if (evt) {
                evt.currentTarget.classList.add("active");
            } else {
                const targetButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }

            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            
            // أضف استدعاء الدالة المناسبة لكل تبويب وتحديث التبويب الرابع دائماً
            if (tabName === 'tab1') {
                calculateAllTab1();
            } else if (tabName === 'tab2') {
                calculateAllTab2();
            } else if (tabName === 'tab3') {
                generateTab3Rows(); // التأكد من وجود الصفوف قبل الحساب
                calculateAllTab3(); 
            } else if (tabName === 'tab4') {
                updateTab4Summary(); // تحديث التبويب الرابع عند فتحه
            } else if (tabName === 'underTrialTab') { // لتبويب الموظف تحت التجربة الجديد
                calculateUnderTrialTab();
            }
        }

        // دالة حسابات التبويب الأول (الكفايات) - تم تصحيحها بناءً على الكود الأصلي والصور
        function calculateAllTab1() {
            const weights = getEvaluationWeights();
            let totalActualLevel = 0;
            let totalDesiredCompetencySum = 0; // مجموع الكفاءة المطلوبة (من أزرار الراديو)

            const competencyRows = document.querySelectorAll('#tab1 .evaluation-table tbody tr[data-competency]');
            const errorMessageDiv = document.getElementById('tab1-error-message');
            errorMessageDiv.style.display = 'none';

            let hasError = false;

            competencyRows.forEach(row => {
                const selectedScoreRadio = row.querySelector('input[type="radio"]:checked');
                const achievedRatioInput = row.querySelector('.achieved-ratio'); // الآن هو حقل نصي للقراءة فقط
                const actualLevelInput = row.querySelector('.actual-level');

                let desiredCompetencyScore = selectedScoreRadio ? parseFloat(selectedScoreRadio.value) : 0;
                // جلب القيمة الثابتة من سمة البيانات
                let achievedRatio = parseFloat(row.dataset.achievedRatio); 

                // إعادة تعيين ألوان الحدود لكل حقل
                Array.from(row.querySelectorAll('input[type="radio"]')).forEach(radio => radio.closest('td').style.border = '');
                
                // التحقق من أن زر راديو قد تم اختياره
                if (!selectedScoreRadio) {
                    Array.from(row.querySelectorAll('input[type="radio"]')).forEach(radio => radio.closest('td').style.border = '1px solid red');
                    if (!hasError) {
                        errorMessageDiv.textContent = 'الرجاء تحديد مستوى الكفاءة المطلوبة لكل بند.';
                        errorMessageDiv.style.display = 'block';
                        hasError = true;
                    }
                    desiredCompetencyScore = 0; // اعتبر القيمة صفر لتجنب أخطاء الحساب
                }

                // حساب المستوى الفعلي للكفاية: (النسبة المحققة / 100) * مستوى الكفاءة المطلوبة
                let calculatedActualLevel = (achievedRatio / 100) * desiredCompetencyScore;
                actualLevelInput.value = formatOutputValue(calculatedActualLevel);
                
                totalActualLevel += calculatedActualLevel;
                totalDesiredCompetencySum += desiredCompetencyScore;
            });

            document.getElementById('totalDesiredCompetency').value = formatOutputValue(totalDesiredCompetencySum);
            document.getElementById('totalActualLevel').value = formatOutputValue(totalActualLevel);

            let finalEvaluation = 0;
            // الحساب كما في الكود الأصلي: (المستوى الفعلي / مجموع مستوى الكفاءة المطلوبة) * 0.20 (أو 0.30 لخدمات المساندة)
            if (totalDesiredCompetencySum > 0) {
                finalEvaluation = (totalActualLevel / totalDesiredCompetencySum) * weights.tab1Weight * 100; // * 100 للحصول على نسبة مئوية
            } else {
                finalEvaluation = 0;
            }

            document.getElementById('finalEvaluation').value = formatOutputValue(finalEvaluation);

            // إخفاء رسالة الخطأ إذا لم تكن هناك أخطاء
            if (!hasError) {
                errorMessageDiv.style.display = 'none';
            }

            updateTab4Summary();
        }


        // دالة حسابات التبويب الثاني (عناصر التميز الوظيفي)
        function calculateAllTab2() {
            let totalDeservedPercentage = 0;
            const tab2Rows = document.querySelectorAll('#tab2 .evaluation-table tbody tr[data-item]');
            const errorMessageDiv = document.getElementById('tab2-error-message');
            errorMessageDiv.style.display = 'none'; 

            let hasError = false;

            tab2Rows.forEach(row => {
                const maxScoreInput = row.querySelector('.max-score-input');
                const deservedPercentageInput = row.querySelector('.deserved-percentage'); 

                let maxScore = parseFloat(maxScoreInput.value);
                let deserved = parseFloat(deservedPercentageInput.value);

                maxScoreInput.style.borderColor = '';
                deservedPercentageInput.style.borderColor = '';

                if (isNaN(maxScore) || isNaN(deserved) || maxScore < 0 || deserved < 0) {
                    if (!hasError) {
                        errorMessageDiv.textContent = 'الرجاء إدخال أرقام صحيحة وغير سالبة في جميع الحقول.';
                        errorMessageDiv.style.display = 'block';
                        hasError = true;
                    }
                    if (isNaN(maxScore) || maxScore < 0) maxScoreInput.style.borderColor = 'red';
                    if (isNaN(deserved) || deserved < 0) deservedPercentageInput.style.borderColor = 'red';
                    return; 
                }

                if (deserved > maxScore) {
                    deservedPercentageInput.style.borderColor = 'red'; 
                    if (!hasError) { 
                        errorMessageDiv.textContent = 'تحذير: قيمة "النسبة المستحقة" لبعض البنود تجاوزت "الأهمية النسبية".';
                        errorMessageDiv.style.display = 'block';
                        hasError = true;
                    }
                }
                
                totalDeservedPercentage += deserved;
            });

            document.getElementById('totalDeservedPercentage').value = formatOutputValue(totalDeservedPercentage);

            if (!hasError && totalDeservedPercentage > 15) {
                errorMessageDiv.textContent = 'خطأ: مجموع النسبة المستحقة تجاوز 15%. الرجاء التعديل.';
                errorMessageDiv.style.display = 'block';
                document.getElementById('totalDeservedPercentage').style.borderColor = 'red';
            } else if (!hasError) {
                errorMessageDiv.style.display = 'none';
                document.getElementById('totalDeservedPercentage').style.borderColor = '';
            }

            updateTab4Summary();
        }

        // دالة لإنشاء صفوف التبويب الثالث ديناميكيًا
        function generateTab3Rows() {
            const numResultsInput = document.getElementById('numResults');
            let numResults = parseInt(numResultsInput.value);
            const tbody = document.getElementById('tab3-tbody');
            tbody.innerHTML = ''; // مسح الصفوف الموجودة

            // تحديث المدى ليكون (1-10)
            if (isNaN(numResults) || numResults < 1) {
                numResults = 1;
                numResultsInput.value = 1;
            } else if (numResults > 10) { 
                numResults = 10;
                numResultsInput.value = 10;
            }

            for (let i = 1; i <= numResults; i++) {
                const row = document.createElement('tr');
                row.setAttribute('data-item', `result${i}`);

                row.innerHTML = `
                    <td>${i}</td>
                    <td style="text-align: right;"><input type="text" value="" placeholder="النتائج المطلوب تحقيقها" style="width: 100%; text-align: right;"></td>
                    <td><input type="number" class="max-score-tab3" oninput="calculateAllTab3()" min="0"></td>
                    <td class="achieved-ratio-cell"><input type="number" class="achieved-percent-tab3" oninput="calculateAllTab3()" min="0" max="100"></td>
                    <td><input type="text" class="deserved-mark-tab3" readonly></td>
                `;
                tbody.appendChild(row);
            }

            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            totalRow.innerHTML = `
                <th colspan="4" style="text-align: right;">مجموع العلامات المستحقة</th>
                <td><input type="text" id="totalDeservedMarkTab3" class="total-value-input" readonly></td>
            `;
            tbody.appendChild(totalRow);

            document.querySelectorAll('#tab3 .evaluation-table input').forEach(input => {
                input.addEventListener('input', calculateAllTab3);
                input.addEventListener('change', calculateAllTab3);
            });

            calculateAllTab3();
        }

        // دالة حسابات التبويب الثالث
        function calculateAllTab3() {
            const weights = getEvaluationWeights();
            let totalDeservedMarkTab3 = 0;
            let totalMaxScoreSum = 0;
            const tab3Rows = document.querySelectorAll('#tab3 .evaluation-table tbody tr[data-item]');
            const errorMessageDiv = document.getElementById('tab3-error-message');
            errorMessageDiv.style.display = 'none';

            let hasInputError = false;
            let hasTotalError = false;

            tab3Rows.forEach(row => {
                const maxScoreInput = row.querySelector('.max-score-tab3');
                const achievedPercentInput = row.querySelector('.achieved-percent-tab3'); 
                const deservedMarkInput = row.querySelector('.deserved-mark-tab3');
                
                if (!maxScoreInput || !achievedPercentInput || !deservedMarkInput) {
                    return; 
                }

                let maxScore = parseFloat(maxScoreInput.value);
                let achievedPercent = parseFloat(achievedPercentInput.value);

                maxScoreInput.style.borderColor = '';
                achievedPercentInput.style.borderColor = '';
                
                if (isNaN(maxScore) || maxScore < 0 || maxScore > 100) {
                    maxScoreInput.style.borderColor = 'red';
                    hasInputError = true;
                    maxScore = 0; // لضمان عدم وجود NaN في الحسابات التالية
                } else {
                    totalMaxScoreSum += maxScore;
                }

                if (isNaN(achievedPercent) || achievedPercent < 0 || achievedPercent > 100) {
                    achievedPercentInput.style.borderColor = 'red';
                    hasInputError = true;
                    achievedPercent = 0; // لضمان عدم وجود NaN في الحسابات التالية
                }
                
                let deservedMark = (maxScore / 100) * achievedPercent;
                deservedMarkInput.value = formatOutputValue(deservedMark); 

                totalDeservedMarkTab3 += isNaN(deservedMark) ? 0 : deservedMark;
            });

            document.getElementById('totalDeservedMarkTab3').value = formatOutputValue(totalDeservedMarkTab3);

            if (hasInputError) {
                errorMessageDiv.textContent = 'الرجاء إدخال أرقام صحيحة بين 0 و 100 في جميع الحقول الملونة بالأحمر.';
                errorMessageDiv.style.display = 'block';
            } 

            document.getElementById('totalDeservedMarkTab3').style.borderColor = '';
            if (totalMaxScoreSum > weights.tab3MaxScoreSum) {
                errorMessageDiv.textContent = `خطأ: مجموع الأهمية النسبية (العلامة القصوى) تجاوز ${weights.tab3MaxScoreSum}%. الرجاء التعديل.`;
                errorMessageDiv.style.display = 'block';
                document.getElementById('totalDeservedMarkTab3').style.borderColor = 'red';
                hasTotalError = true;
            } else if (totalMaxScoreSum < weights.tab3MaxScoreSum && !hasInputError) {
                // لا يوجد تحذير هنا إذا كان المجموع أقل من 65% أو 55% ولا توجد أخطاء فردية
                errorMessageDiv.style.display = 'none';
            } else if (!hasInputError && !hasTotalError) {
                errorMessageDiv.style.display = 'none';
            }

            updateTab4Summary();
        }

        // دالة تحديث التبويب الرابع (تقييم الأداء) للوظائف التخصصية والمساندة
        function updateTab4Summary() {
            // يتم استدعاء هذه الدالة فقط لأنواع التقييم التي تستخدم التبويبات القياسية
            const evaluationType = document.getElementById('evaluationType').value;
            if (evaluationType === 'underTrial') {
                // لا تفعل شيئا إذا كان نوع التقييم هو "تحت التجربة"
                return;
            }

            const tab3Mark = parseFloat(document.getElementById('totalDeservedMarkTab3').value) || 0;
            const tab1Evaluation = parseFloat(document.getElementById('finalEvaluation').value) || 0;
            const tab2Percentage = parseFloat(document.getElementById('totalDeservedPercentage').value) || 0;

            document.getElementById('summaryTab3Mark').value = formatOutputValue(tab3Mark);
            document.getElementById('summaryTab1Evaluation').value = formatOutputValue(tab1Evaluation);
            document.getElementById('summaryTab2Percentage').value = formatOutputValue(tab2Percentage);

            const finalTotalScore = tab3Mark + tab1Evaluation + tab2Percentage;
            document.getElementById('finalTotalScore').value = formatOutputValue(finalTotalScore);

            let overallGrade = '';
            if (finalTotalScore >= 90) {
                overallGrade = 'ممتاز';
            } else if (finalTotalScore >= 80) {
                overallGrade = 'جيد جداً';
            } else if (finalTotalScore >= 70) {
                overallGrade = 'جيد';
            } else if (finalTotalScore >= 60) {
                overallGrade = 'مقبول';
            } else {
                overallGrade = 'ضعيف';
            }
            document.getElementById('overallGrade').value = overallGrade;
        }

        // دالة حسابات تبويب الموظف تحت التجربة الجديد
        function calculateUnderTrialTab() {
            let totalAchievedScore = 0;
            const underTrialRows = document.querySelectorAll('#underTrialTab .evaluation-table tbody tr[data-item]');
            const errorMessageDiv = document.getElementById('underTrial-error-message');
            errorMessageDiv.style.display = 'none';

            let hasError = false;

            underTrialRows.forEach(row => {
                const achievedMarkInput = row.querySelector('.achieved-mark-underTrial');
                const maxScoreCell = row.cells[2]; // العلامة القصوى هي الخلية الثالثة (index 2)
                const maxScore = parseInt(maxScoreCell.textContent); // قراءة القيمة الثابتة

                let achievedMark = parseFloat(achievedMarkInput.value);

                achievedMarkInput.style.borderColor = ''; // إعادة تعيين لون الحدود

                if (isNaN(achievedMark) || achievedMark < 0 || achievedMark > maxScore) {
                    achievedMarkInput.style.borderColor = 'red';
                    if (!hasError) {
                        errorMessageDiv.textContent = 'الرجاء إدخال أرقام صحيحة وغير سالبة، ولا تتجاوز العلامة القصوى لكل بند.';
                        errorMessageDiv.style.display = 'block';
                        hasError = true;
                    }
                    totalAchievedScore += 0; // لا تحسب القيمة غير الصالحة
                } else {
                    totalAchievedScore += achievedMark;
                }
            });

            document.getElementById('totalAchievedUnderTrial').value = formatOutputValue(totalAchievedScore);

            // تحديد التقدير العام مباشرة بناءً على المجموع الكلي
            let overallGrade = '';
            if (totalAchievedScore >= 90) {
                overallGrade = 'ممتاز';
            } else if (totalAchievedScore >= 80) {
                overallGrade = 'جيد جداً';
            } else if (totalAchievedScore >= 70) {
                overallGrade = 'جيد';
            } else if (totalAchievedScore >= 60) {
                overallGrade = 'مقبول';
            } else {
                overallGrade = 'ضعيف';
            }
            document.getElementById('overallGradeUnderTrial').value = overallGrade;

            if (!hasError) {
                errorMessageDiv.style.display = 'none';
            }
        }


        // تهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            // استدعاء showEvaluationForms مرة واحدة لتهيئة العرض الافتراضي
            showEvaluationForms();

            // إضافة مستمعين للأحداث لكل حقول الراديو في التبويب الأول (فقط الراديو يؤثر الآن)
            document.querySelectorAll('#tab1 .evaluation-table input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', calculateAllTab1);
            });
            
            // إضافة مستمعين للأحداث لكل حقول الإدخال في التبويب الثاني
            document.querySelectorAll('#tab2 .evaluation-table input').forEach(input => {
                input.addEventListener('input', calculateAllTab2);
                input.addEventListener('change', calculateAllTab2);
            });
            // إضافة مستمعين للأحداث لحقل تحديد عدد النتائج
            document.getElementById('numResults').addEventListener('change', generateTab3Rows);

            // إضافة مستمعين للأحداث لحقول الإدخال في تبويب الموظف تحت التجربة
            document.querySelectorAll('#underTrialTab .evaluation-table input[type="number"]').forEach(input => {
                input.addEventListener('input', calculateUnderTrialTab);
                input.addEventListener('change', calculateUnderTrialTab);
            });

            // استدعاء generateTab3Rows لأول مرة عند تحميل الصفحة لإنشاء الصفوف الافتراضية
            generateTab3Rows(); 
        });
    </script>
</body>
</html>
